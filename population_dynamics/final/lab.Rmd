---
title: FAS6337C - Final Exam
author: Marcel Gietzmann-Sanders
---

```{r}
library(lme4)

col2rgbA<-function(color,transparency)
{
  rgb(t(col2rgb(color))/255,alpha=transparency)
}
```

```{r}
setwd("/workspaces/schooling/population_dynamics/final/") 
data <- read.table("data/King_Mackerel_sim-1.csv", header=T, sep=",") 
data$Age <- as.numeric(data$Age)
head(data)
```

# 1. Fit a length-weight relationship to the pooled (regardless of sex) data.

```{r}
data$lTL <- log(data$TL)
data$lWt <- log(data$Wt)
```

```{r}
plot(
    data$lTL, 
    data$lWt, 
    xlab="log(Length)", 
    ylab="log(Weight)", 
    main="Length-Weight Relationship"
)
```

## a. Report the length-weight parameters

```{r}
(fit <- lm(lWt ~ lTL, data=data))
```

```{r}
a <- exp(coef(fit)[1])
b <- coef(fit)[2]
c(a, b)
```

## b. Plot the mean weight at age against the data
```{r}
data$predWt <- a * data$TL^b
plot(
    data$TL, 
    data$Wt, 
    xlab="Length", 
    ylab="Weight", 
    main="Length-Weight Relationship"
)
lines(data$TL[order(data$TL)], data$predWt[order(data$TL)], col="red")
```

# 2. Fit a series of von Bertalanffy growth models to the King Mackerel data. Determine if males and females exihibit secually dimorphic growth.

```{r}
filtered_data <- na.omit(data)
head(filtered_data)
```

```{r}
plot(
    filtered_data$Age, 
    filtered_data$TL, 
    xlab="Age", 
    ylab="Length", 
    main="Length-Age Relationship"
)
```

```{r}
predict_length <- function(yearsold, Linf, vbk, tknot) {
  pred_tl <- Linf * (1 - exp(-vbk * (yearsold - tknot)))
  return(pred_tl)
}

get_likelihood <- function(yearsold, tl, Linf, vbk, tknot, sig) {
  pred_tl <- predict_length(yearsold, Linf, vbk, tknot)
  NLL <- -1 * sum(dnorm(tl, pred_tl, sig, log=T), na.rm=T)
  return(NLL)
}
```

```{r}
map_columns <- function(v, cols) {
    c <- rep(0, 8)
    i <- 0
    for (col in cols) {
        i <- i + 1
        if (endsWith(col, 'Linf')) {
            j <- 1
        } else if (endsWith(col, 'vbk')) {
            j <- 3
        } else if (endsWith(col, 'tknot')) {
            j <- 5
        } else {
            j <- 7
        }

        if (startsWith(col, 'f_')) {
            c[j] <- v[i]
        } else if (startsWith(col, 'm_')) {
            c[j+1] <- v[i]
        } else {
            c[j] <- v[i]
            c[j+1] <- v[i]
        }
    }
    return(c)
}

map_columns(c(1, 3, 2, 3, 4), c('m_Linf', 'f_Linf', 'vbk', 'tknot', 'sig'))
```

```{r}
male_data <- filtered_data[filtered_data$Sex == 'M',]
female_data <- filtered_data[filtered_data$Sex == 'F',]
```

```{r}
do_likelihood_fit <- function(v, cols, runs) {
  objective <- function(v) {
    c <- map_columns(v, cols)

    f_Linf <- exp(c[1])
    f_vbk <- c[3]
    f_tknot <- c[5]
    f_sig <- exp(c[7])

    m_Linf <- exp(c[2])
    m_vbk <- c[4]
    m_tknot <- c[6]
    m_sig <- exp(c[8])

    f_NLL <- get_likelihood(female_data$Age, female_data$TL, f_Linf, f_vbk, f_tknot, f_sig)
    m_NLL <- get_likelihood(male_data$Age, male_data$TL, m_Linf, m_vbk, m_tknot, m_sig)

    NLL <- f_NLL + m_NLL
    return(NLL)
  }

  for (i in 1:runs) {
    fit <- optim(v, objective, hessian=T)
    v <- fit$par
  }
  return(fit)
}

summarize_aic <- function(fit, cols) {
  dof <- length(cols)
  nll <- fit$value
  aic <- 2*nll + 2*dof
  row <- c(paste(cols, collapse=','), dof, nll, aic)
  return(row)
}
```

## a. Use AIC model comparison to determine if growth rates are sexually dimorphic.

### All Parameters Free

```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  0.2, -1.2,  4.1
) 
cols <- c(
  'f_Linf', 'f_vbk', 'f_tknot', 'f_sig',
  'm_Linf', 'm_vbk', 'm_tknot', 'm_sig'
)
(fit <- do_likelihood_fit(v, cols, 25))
(all_free <- summarize_aic(fit, cols))
```

```{r}
plot(
    female_data$Age, 
    female_data$TL, 
    xlab="Age", 
    ylab="Length", 
    main="Length-Age Relationship",
    col="orange"
)
points(
    male_data$Age, 
    male_data$TL, 
    xlab="Age", 
    ylab="Length", 
    col="blue"
)
lines(
    female_data$Age[order(female_data$Age)], 
    predict_length(
        female_data$Age[order(female_data$Age)], 
        exp(fit$par[1]), 
        fit$par[2], 
        fit$par[3]
    ), 
    col="orange"
)
lines(
    male_data$Age[order(male_data$Age)], 
    predict_length(
        male_data$Age[order(male_data$Age)], 
        exp(fit$par[5]), 
        fit$par[6], 
        fit$par[7]
    ), 
    col="blue"
)
```

### One Parameter Shared
```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  0.2, -1.2,  4.1
) 
cols <- c(
  'Linf', 'f_vbk', 'f_tknot', 'f_sig',
  'm_vbk', 'm_tknot', 'm_sig'
)
(fit <- do_likelihood_fit(v, cols, 25))
(Linf_shared <- summarize_aic(fit, cols))
```

```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  -1.2,  4.1
) 
cols <- c(
  'f_Linf', 'vbk', 'f_tknot', 'f_sig',
  'm_Linf', 'm_tknot', 'm_sig'
)
(fit <- do_likelihood_fit(v, cols, 25))
(vbk_shared <- summarize_aic(fit, cols))
```

```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  0.2, 4.1
) 
cols <- c(
  'f_Linf', 'f_vbk', 'tknot', 'f_sig',
  'm_Linf', 'm_vbk', 'm_sig'
)
(fit <- do_likelihood_fit(v, cols, 25))
(tknot_shared <- summarize_aic(fit, cols))
```

```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  0.2, -1.2
) 
cols <- c(
  'f_Linf', 'f_vbk', 'f_tknot', 'sig',
  'm_Linf', 'm_vbk', 'm_tknot'
)
(fit <- do_likelihood_fit(v, cols, 25))
(sig_shared <- summarize_aic(fit, cols))
```

### All Parameters Shared
```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7
) 
cols <- c(
  'Linf', 'vbk', 'tknot', 'sig'
)
(fit <- do_likelihood_fit(v, cols, 25))
(all_shared <- summarize_aic(fit, cols))
```

### $\sigma$ and $t_0$ shared
```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  0.2
) 
cols <- c(
  'f_Linf', 'f_vbk', 'tknot', 'sig',
  'm_Linf', 'm_vbk'
)
(fit <- do_likelihood_fit(v, cols, 25))
(sig_and_tknot_shared <- summarize_aic(fit, cols))
```

## b. Report an AIC table.

```{r}
aic_table <- data.frame(rbind(
    all_free,
    all_shared,
    Linf_shared,
    vbk_shared,
    tknot_shared,
    sig_shared,
    sig_and_tknot_shared
))
colnames(aic_table) <- c('cols', 'dof', 'nll', 'aic')

aic_table$aic <- as.numeric(aic_table$aic)
aic_table$delta <- aic_table$aic - min(aic_table$aic)
(aic_table <- aic_table[order(aic_table$delta),])
```

These are definitely sexually dimorphic growth rates. The model with all parameters free has the lowest AIC.

## c. Which VBGF parameters differ between sexes in your top model?

Given $\sigma$ and $t_0$ being shared is within 4 AIC of the fully free model I'm going to say that $L_{\infty}$ and $K$ are different between sexes. 

## d. Report the VBGF parameter means and 95% confidence intervals from your top model
```{r}
v <- c(
  6.7, 0.2, -1.5,  3.7,
  6.9,  0.2
) 
cols <- c(
  'f_Linf', 'f_vbk', 'tknot', 'sig',
  'm_Linf', 'm_vbk'
)
(fit <- do_likelihood_fit(v, cols, 25))
(sig_and_tknot_shared <- summarize_aic(fit, cols))
```

```{r}
stderr <- sqrt(diag(solve(fit$hessian)))
stderr

ALPHA <- 0.05
P_L95 <- (fit$par - qnorm(1-(ALPHA/2)) * stderr)
P_MEAN <- fit$par
P_U95 <- (fit$par + qnorm(1-(ALPHA/2)) * stderr)
P_U95[1] <- exp(P_U95[1])
P_MEAN[1] <- exp(P_MEAN[1])
P_L95[1] <- exp(P_L95[1])
P_U95[4] <- exp(P_U95[4])
P_MEAN[4] <- exp(P_MEAN[4])
P_L95[4] <- exp(P_L95[4])
P_U95[5] <- exp(P_U95[5])
P_MEAN[5] <- exp(P_MEAN[5])
P_L95[5] <- exp(P_L95[5])
```

```{r}
tab <- rbind(P_L95, P_MEAN, P_U95)
colnames(tab) <- c('f_Linf', 'f_K', 't0', 'sigma', 'm_Linf', 'm_K')
tab
```

## e. Plot the resulting male and female predicted length at age from your top model against the data.

```{r}
plot(
    female_data$Age, 
    female_data$TL, 
    xlab="Age", 
    ylab="Length", 
    main="Length-Age Relationship",
    col="orange"
)
points(
    male_data$Age, 
    male_data$TL, 
    xlab="Age", 
    ylab="Length", 
    col="blue"
)
lines(
    female_data$Age[order(female_data$Age)], 
    predict_length(
        female_data$Age[order(female_data$Age)], 
        exp(fit$par[1]), 
        fit$par[2], 
        fit$par[3]
    ), 
    col="orange"
)
lines(
    male_data$Age[order(male_data$Age)], 
    predict_length(
        male_data$Age[order(male_data$Age)], 
        exp(fit$par[5]), 
        fit$par[6], 
        fit$par[3]
    ), 
    col="blue"
)
legend(x=1.5, y=1300, pch=19, legend=c("Female", "Male"), col=c("orange", "blue"))
```

# 3. Fit a series of logistic maturity models to the King Mackerel data. Determine if males and females exhibit sexually dimorphic maturity.

```{r}
get_nll <- function(theta) {
    f_lmat50 <- theta[1]
    f_sig <- theta[2]
    m_lmat50 <- theta[3]
    m_sig <- theta[4]

    prob_mat_female <- 1 / (1 + exp(-(female_data$TL - f_lmat50) / f_sig))
    prob_mat_male <- 1 / (1 + exp(-(male_data$TL - m_lmat50) / m_sig))
    nll_female <- -1*sum(dbinom(female_data$Mat, size=1, prob=prob_mat_female, log=T))
    nll_male <- -1*sum(dbinom(male_data$Mat, size=1, prob=prob_mat_male, log=T))
    return(nll_female + nll_male)
}
```

```{r}
subset_theta <- function(theta, params_to_fit) {
    input <- c()
    for (i in 1:length(params_to_fit)) {
        input <- append(input, theta[params_to_fit[i]])
    }
    return(input)
}

update_theta <- function(theta, input, params_to_fit, index_to_share) {
    v = theta
    for (i in 1:length(params_to_fit)) {
        v[params_to_fit[i]] <- input[i]
    }
    for (i in 1:length(v)) {
        if (!(i %in% params_to_fit)) {
            v[i] <- v[index_to_share[i]]
        }
    }
    return(v)
}

do_fit <- function(theta, params_to_fit, index_to_share) {

    fun <- function(input) {
        v = update_theta(theta, input, params_to_fit, index_to_share)
        return(get_nll(v))
    }

    input <- subset_theta(theta, params_to_fit)
    for (i in 1:10) {
        fit <- optim(input, fun, hessian=T)
        input <- fit$par
    }
    theta <- update_theta(theta, input, params_to_fit, index_to_share)
    return(theta)
}

get_aic <- function(theta, params_to_fit) {
    nll <- get_nll(theta)
    k <- length(params_to_fit)
    aic <- 2*k + 2*nll
    return(c(nll, k, aic))
}
```

## a. Use AIC model comparison to determine if growth rates are sexually dimorphic.

```{r}

starting_guess <- c(200, 20, 200, 20)
index_to_share <- c(3, 4, 1, 2)
row_names <- c()
col_names <- c("f_lmat50", "f_sig", "m_lmat50", "m_sig", "nll", "params", "AIC")

params_to_fit <- c(1, 2, 3)
theta <- do_fit(starting_guess, params_to_fit, index_to_share)
aic_info <- get_aic(theta, params_to_fit)
row1 <- c(theta, aic_info)
row_names <- append(row_names, "L(h)sig(.)")

params_to_fit <- c(1, 2, 4)
theta <- do_fit(starting_guess, params_to_fit, index_to_share)
aic_info <- get_aic(theta, params_to_fit)
row2 <- c(theta, aic_info)
row_names <- append(row_names, "L(.)sig(h)")

params_to_fit <- c(1, 2)
theta <- do_fit(starting_guess, params_to_fit, index_to_share)
aic_info <- get_aic(theta, params_to_fit)
row3 <- c(theta, aic_info)
row_names <- append(row_names, "L(.)sig(.)")

params_to_fit <- c(1, 2, 3, 4)
theta <- do_fit(starting_guess, params_to_fit, index_to_share)
aic_info <- get_aic(theta, params_to_fit)
row4 <- c(theta, aic_info)
row_names <- append(row_names, "L(h)sig(h)")
```

## b. Report an AIC table.
```{r}
results <- rbind(row1, row2, row3, row4)
colnames(results) <- col_names
rownames(results) <- row_names
results <- data.frame(results)

results <- results[order(results$AIC),]
results$delta_aic <- results$AIC - results$AIC[1]
results
```

## c. Which maturity parameters differ between sexes in your top model?
Technically the top model differs only in $\sigma$ but honestly the top three models are barely distuinguishable on the basis of AIC alone. I'm going to go, in this case, with the model with the most degrees of freedom where both $L_{mat}$ and $\sigma$ are free. That way if there are biological differences we are capturing them. 

## d. Report the logistic maturity model parameter means and 95% confidence intervals from your top model.

```{r}
theta <- results[2, 1:4]
for (i in 1:10) {
    fit <- optim(theta, get_nll, hessian=T)
    theta <- fit$par
}
theta
```

```{r}
stderr <- sqrt(diag(solve(fit$hessian)))
stderr

ALPHA <- 0.05
P_L95 <- (fit$par - qnorm(1-(ALPHA/2)) * stderr)
P_MEAN <- fit$par
P_U95 <- (fit$par + qnorm(1-(ALPHA/2)) * stderr)

tab <- rbind(P_L95, P_MEAN, P_U95)
colnames(tab) <- c('f_lmat50', 'f_sig', 'm_lmat50', 'm_sig')
tab
```

## e. Plot the resulting male and female predicted maturity at length from your top model against the data.

```{r}
plot(
    female_data$TL,
    female_data$Mat,
    xlab="Length",
    ylab="Maturity",
    main="Female Maturity-Length Relationship",
)
lines(
    female_data$TL[order(female_data$TL)],
    1 / (1 + exp(-(female_data$TL[order(female_data$TL)] - fit$par[1]) / fit$par[2])),
    col="orange"
)
```

```{r}
plot(
    male_data$TL,
    male_data$Mat,
    xlab="Length",
    ylab="Maturity",
    main="Male Maturity-Length Relationship",
)
lines(
    male_data$TL[order(male_data$TL)],
    1 / (1 + exp(-(male_data$TL[order(male_data$TL)] - fit$par[3]) / fit$par[4])),
    col="blue"
)
```

# 4. Using the age composition data from the fishery dependent samples:

```{r}
fishery_data <- data[data$Fishery,]
aged <- na.omit(fishery_data[,c('Age', 'TL')])
aged$cmgrp <- floor(aged$TL / 10)
(length(aged$TL))
(length(fishery_data$TL))
head(aged)
```

## a. Generate an age-length key and project the age of samples with only lengths.

```{r}
get_ALK <- function(aged) {
    ALK <- data.frame(
        prop.table(
            table(aged$Age, aged$cmgrp),
            margin=2
        )
    )
    names(ALK) <- c("Age","cmgrp","prop") 
    ALK$Age <- as.numeric(as.character(ALK$Age))
    ALK$cmgrp <- as.numeric(as.character(ALK$cmgrp))
    ALK$prop <- as.numeric(as.character(ALK$prop))
    ALK$col.prop <- hcl.colors(101,'viridis')[round(ALK$prop,2)*100+1]
    return(ALK)
}

ALK <- get_ALK(aged)
head(ALK)
```

```{r}
get_catch_count_info <- function(catch, ALK) {
    catch_summary <- data.frame(table(catch$cmgrp))
    names(catch_summary) <- c("cmgrp", "total")
    catch_summary$cmgrp <- as.numeric(as.character(catch_summary$cmgrp))
    catch_summary$total <- as.numeric(as.character(catch_summary$total))
    info <- merge(ALK, catch_summary)
    info$count <- info$total * info$prop
    return(info)
}

catch <- na.omit(fishery_data[, c('TL', 'Fishery')])
catch$cmgrp <- floor(catch$TL / 10)
catch_info <- get_catch_count_info(catch, ALK)
head(catch_info)
```

```{r}
get_CAA <- function(catch_info) {
    CAA <- aggregate(count~Age, data=catch_info, sum)
    return(CAA)
}

(CAA <- get_CAA(catch_info))
```

### i. Plot a bubble plot of the age-length key.


```{r}
plot_ALK <- function(ALK, main) {
    # I want the circles to have area equal to
    # my proportion (for easier interpretation)
    # this would mean prop <- 4 * pi * r^2 or 
    # r <- sqrt(prop / (4 * pi))
    with(
        ALK, {
            symbols(
                x=cmgrp,
                y=Age,
                circles=sqrt(prop/(4 * pi)) * 2,
                inches=F,
                fg = col.prop,
                bg = col2rgbA(col.prop,0.5),
                xlab="Centimeter Group",
                ylab="Age",
                main=main
            )
        }
    )
}

plot_ALK(ALK, "Age-Length Key")
```

### ii. Plot the total catch at age data.

```{r}
with(
    CAA, {
        plot(
            Age,
            count,
            type='b',
            pch=16,
            col="black",
            xlab="Age",
            ylab="Count",
            main='Catch at Age'
        )
    }
)
```

## b. Estimate and report the instantaneous (Z) and finite (A) total mortality for this population. Justify the method you used to estimate Z and the data you included in the estimate.

```{r}
reshape_for_millar <- function(CAA) {
    age_at_peak <- CAA$Age[which.max(CAA$count)]
    CAA_lim <- CAA[CAA$Age >= age_at_peak,]

    max_age <- max(CAA_lim$Age)
    CAA_ext <- rbind(
        CAA_lim,
        cbind(
            Age=(max_age+1):(2*max_age),
            count=rep(0,max_age)
        )
    )
    CAA_ext$count <- floor(CAA_ext$count)
    return(CAA_ext)
}

get_millar_fit <- function(CAA) {
    CAA_ext <- reshape_for_millar(CAA)

    fit <- glmer(
        count ~ Age + (1|Age),
        family=poisson,
        data=CAA_ext
    )
    print(summary(fit))
    return(fit)
}

(millar_fit <- get_millar_fit(CAA))
```

```{r}
get_params_from_millar <- function(millar_fit, alpha) {
    coef <- summary(millar_fit)$coef
    Z <- coef[2, 1]
    std <- coef[2, 2]
    ZU <- min(Z + qnorm(1-alpha/2)*std, 0)
    ZL <- Z - qnorm(1-alpha/2)*std

    A <- 1 - exp(Z)
    AU <- 1 - exp(ZU)
    AL <- 1 - exp(ZL)

    S <- exp(Z)
    SU <- exp(ZU)
    SL <- exp(ZL)

    m <- matrix(c(ZL, Z, ZU, AL, A, AU, SL, S, SU),3,3)
        colnames(m) <- c("Z", "A", "S")
        rownames(m) <- c("Lower", "MLE", "Upper")
    return(m)
}

get_params_from_millar(millar_fit, 0.05)
```

## c. Choose a single natural mortality surrogate method and estimate the natural mortality rate (M) for this population using your chosen surrogate method (use female-based parameters where appropriate).

Using the surrogate method from our Yield per Recruit analyses in the previous assignments we have:

$$M = -1.5K$$ 

```{r}
(M = -1.5 * 0.2257593)
```


## d. What is the fishing mortality rate (F) for this population assuming the M you estimated using surrogate methods?

```{r}
Z = -0.4718949
(F = Z - M)
```

### i. Discuss your level of confidence for this F estimate.

First of all we have to consider the uncertainty in Z itself. Z ranged from -0.51 to -0.43 which is a range of -0.08.
This range is itself equivalent to the value of F that we are estimated at present. Furthermore this M was taken from a
surrogate method which we know is highly approximate in the first place. So I'd definitely don't have a lot of confidence
in this estimate of F.




